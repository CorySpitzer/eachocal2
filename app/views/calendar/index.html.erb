<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div class="calendar-container" data-controller="calendar skill-colors">
        <%= javascript_include_tag "calendar" %>
        <div class="calendar-header">
          <div class="calendar-nav">
            <%= link_to calendar_path(year: @prev_month.year, month: @prev_month.month),
                        class: "nav-btn",
                        data: { turbo_frame: "calendar" } do %>
              <i class="bi bi-chevron-left"></i>
            <% end %>
            <h2 class="calendar-title"><%= @current_date.strftime("%B %Y") %></h2>
            <%= link_to calendar_path(year: @next_month.year, month: @next_month.month),
                        class: "nav-btn",
                        data: { turbo_frame: "calendar" } do %>
              <i class="bi bi-chevron-right"></i>
            <% end %>
          </div>

          <div class="subject-selector">
            <%= form_tag calendar_path, method: :get, class: "subject-form", data: { turbo_frame: "calendar" } do %>
              <div class="form-group">
                <%= select_tag :subject_id,
                              options_from_collection_for_select(current_user.subjects, :id, :name, params[:subject_id]),
                              prompt: "All Subjects",
                              class: "form-select",
                              onchange: "this.form.requestSubmit()" %>
              </div>
            <% end %>

            <% if @selected_subject %>
              <%= link_to "Add New Skill", new_subject_skill_path(@selected_subject), class: "btn btn-sm btn-outline-primary ms-2" %>
            <% end %>
          </div>
        </div>

        <div class="calendar-grid">
          <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
            <div class="calendar-day-header"><%= day %></div>
          <% end %>
          
          <% date = @start_date %>
          <% while date <= @end_date do %>
            <div class="calendar-day <%= 'other-month' if date.month != @current_date.month %>">
              <div class="day-number"><%= date.day %></div>
              <div class="practice-markers">
              <% @calendar_data.each do |skill| %>
                <% if skill[:completed_sessions].include?(date.to_date) %>
                  <% session = skill[:practice_sessions].find { |s| s.scheduled_date == date.to_date } %>
                  <div class="practice-marker completed" 
                       data-color="<%= skill[:color] %>"
                       data-session-id="<%= session.id %>"
                       data-rating="<%= session.rating %>"
                       data-bs-toggle="tooltip"
                       style="opacity: <%= 0.2 + (session.rating || 0) * 0.16 %>;"
                       title="Completed: <%= skill[:name] %> (<%= 'â˜…' * session.rating %>)"></div>
                <% end %>
                <% if skill[:scheduled_sessions].include?(date.to_date) %>
                  <% session = skill[:practice_sessions].find { |s| s.scheduled_date == date.to_date } %>
                  <div class="practice-marker scheduled" 
                       data-color="<%= skill[:color] %>"
                       data-session-id="<%= session.id %>"
                       data-rating="0"
                       data-bs-toggle="tooltip"
                       title="Scheduled: <%= skill[:name] %>"></div>
                <% end %>
              <% end %>
              </div>
            </div>
            <% date = date.next_day %>
          <% end %>
        </div>
        <div class="calendar-legend">
          <% @calendar_data.each do |skill| %>
            <div class="skill-legend-item">
              <div class="legend-markers">
                <div class="legend-marker completed" data-color="<%= skill[:color] %>"></div>
                <div class="legend-marker scheduled" data-color="<%= skill[:color] %>"></div>
              </div>
              <div class="legend-name"><%= skill[:name] %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="skills-selector mb-4" data-controller="subject-skills">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="subject_id" class="form-label">Subject</label>
            <%= select_tag :subject_id, 
                options_from_collection_for_select(
                  @subjects || [], 
                  :id, 
                  :name, 
                  @selected_subject&.id
                ),
                { 
                  prompt: "Select a subject",
                  class: "form-select",
                  data: { 
                    subject_skills_target: "subjectSelect",
                    action: "change->subject-skills#updateSkillsDropdown",
                    skills: (@subjects || []).map { |s| { id: s.id, name: s.name, skills: s.skills.map { |skill| { id: skill.id, name: skill.name } } }.to_json }
                  }
                } %>
          </div>
          
          <div class="col-md-4">
            <label for="skill_id" class="form-label">Skill</label>
            <%= select_tag :skill_id,
                options_for_select([["Select a skill", ""]]),
                class: "form-select",
                data: { subject_skills_target: "skillSelect" } %>
          </div>
          
          <div class="col-md-4 d-flex align-items-end">
            <% if @selected_subject %>
              <%= link_to "Add New Skill", 
                  new_subject_skill_path(@selected_subject),
                  class: "btn btn-outline-primary",
                  data: { subject_skills_target: "newSkillLink" } %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for :scripts do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });
  </script>
<% end %>
